<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>War Manager â€“ Full Version</title>
  <style>
    /* Global Styles */
    * { box-sizing: border-box; }
    body {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f0f2f5;
      margin: 0;
      padding: 20px;
      color: #333;
    }
    header {
      text-align: center;
      margin-bottom: 20px;
    }
    header button {
      padding: 10px 20px;
      margin: 0 10px;
      border: none;
      border-radius: 4px;
      background-color: #007bff;
      color: white;
      cursor: pointer;
    }
    header button.active {
      background-color: #0056b3;
    }
    h1, h2, h3, h4 { text-align: center; margin: 10px 0; }
    /* Ban List Section */
    #banListContainer {
      background-color: #fff;
      border: 1px solid #ced4da;
      border-radius: 6px;
      padding: 15px;
      margin: 0 auto 20px;
      max-width: 800px;
    }
    #banListHeader {
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      font-size: 18px;
      color: #2c3e50;
    }
    #banListHeader button {
      background-color: #007bff;
      border: none;
      color: white;
      padding: 5px 10px;
      border-radius: 4px;
      cursor: pointer;
    }
    #banListContent { margin-top: 10px; }
    #banList {
      width: 100%;
      height: 100px;
      font-family: monospace;
      border: 1px solid #ced4da;
      border-radius: 4px;
      padding: 8px;
      resize: vertical;
    }
    #applyBanList {
      margin-top: 10px;
      padding: 6px 15px;
      font-size: 14px;
      background-color: #28a745;
      border: none;
      color: #fff;
      border-radius: 4px;
      cursor: pointer;
    }
    /* Import Section */
    #importSection {
      text-align: center;
      margin-bottom: 20px;
    }
    #importSection input[type="file"] {
      margin: 10px 0;
    }
    #loadJsonButton {
      padding: 8px 16px;
      font-size: 14px;
      background-color: #17a2b8;
      border: none;
      color: #fff;
      border-radius: 4px;
      cursor: pointer;
    }
    /* Global Available Characters Panel */
    #globalCharactersPanel {
      background-color: #fff;
      border: 1px solid #ced4da;
      padding: 15px;
      border-radius: 6px;
      margin: 0 auto 20px;
      max-width: 800px;
    }
    #globalCharactersPanel h2 {
      text-align: center;
      margin-bottom: 10px;
    }
    #filterBox {
      margin-bottom: 10px;
      text-align: center;
    }
    #filterBox input {
      width: 90%;
      padding: 6px;
      font-size: 14px;
      border: 1px solid #ced4da;
      border-radius: 4px;
    }
    #charactersList {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
      gap: 10px;
      max-height: 300px;
      overflow-y: scroll;
    }
    .character {
      background-color: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      padding: 5px;
      text-align: center;
      cursor: pointer;
      transition: transform 0.1s ease-in-out;
    }
    .character:hover { transform: scale(1.05); }
    .character img {
      width: 46px;
      height: 46px;
      display: block;
      margin: 0 auto 5px;
      border-radius: 3px;
    }
    /* Modal for Character Picker in Tracker */
    #characterPickerModal {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    #characterPickerModal .modal-content {
      background: #fff;
      padding: 20px;
      border-radius: 6px;
      max-width: 600px;
      width: 90%;
      max-height: 80%;
      overflow-y: auto;
    }
    #characterPickerModal h3 {
      margin-top: 0;
      text-align: center;
    }
    /* Added input for filtering within the modal */
    #pickerFilter {
      width: 100%;
      padding: 6px;
      margin-bottom: 10px;
      border: 1px solid #ced4da;
      border-radius: 4px;
    }
    #characterPickerModal .picker-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
      gap: 10px;
      margin: 10px 0;
    }
    #characterPickerModal .picker-item {
      border: 2px solid transparent;
      border-radius: 4px;
      padding: 5px;
      cursor: pointer;
      transition: border 0.2s;
    }
    #characterPickerModal .picker-item.selected {
      border: 2px solid #28a745;
    }
    #characterPickerModal .modal-buttons {
      text-align: center;
      margin-top: 10px;
    }
    #characterPickerModal button {
      padding: 6px 12px;
      margin: 0 5px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    #confirmPicker, #cancelPicker {
      font-size: 14px;
    }
    #confirmPicker { background-color: #28a745; color: #fff; }
    #cancelPicker { background-color: #dc3545; color: #fff; }
    /* Page Container */
    .page { display: none; }
    .page.active { display: block; }
    /* Main Container for Pages */
    #pagesContainer {
      max-width: 1200px;
      margin: 0 auto;
    }
    /* Team Builder Layout */
    #builderPage #mainContainer {
      display: flex;
      gap: 20px;
      justify-content: space-between;
      flex-wrap: wrap;
    }
    .pane {
      background-color: #fff;
      border: 1px solid #ced4da;
      padding: 15px;
      border-radius: 6px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    /* Team Builder: Team Assembly Pane */
    #teamArea {
      flex: 1;
      min-width: 220px;
      max-width: 260px;
      text-align: center;
    }
    #teamArea h2 { margin-bottom: 10px; }
    #teamSlots {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 10px;
    }
    .team-slot {
      background-color: #fdfdfe;
      border: 2px dashed #adb5bd;
      width: 70px;
      height: 70px;
      border-radius: 4px;
      position: relative;
      transition: background-color 0.2s;
    }
    .team-slot.over { background-color: #e9ecef; }
    .team-slot img { width: 100%; height: 100%; border-radius: 4px; }
    .remove-btn {
      position: absolute;
      top: -8px;
      right: -8px;
      background: #dc3545;
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      font-size: 14px;
      line-height: 18px;
      cursor: pointer;
    }
    #checkTeamButton {
      margin-top: 10px;
      padding: 8px 16px;
      font-size: 14px;
      background-color: #007bff;
      border: none;
      color: #fff;
      border-radius: 4px;
      cursor: pointer;
    }
    #validationReport {
      margin-top: 10px;
      font-weight: bold;
      color: #dc3545;
      white-space: pre-wrap;
    }
    #tagSummary { margin-top: 15px; }
    .tag { margin: 4px 0; font-weight: bold; font-size: 14px; }
    /* Character Details Pane */
    #detailsPane {
      flex: 1;
      min-width: 280px;
      max-width: 360px;
    }
    #detailsPane h2 { margin-bottom: 10px; }
    #detailsDisplay {
      white-space: pre-wrap;
      word-wrap: break-word;
      font-size: 14px;
      line-height: 1.5;
      border: 1px solid #ced4da;
      padding: 10px;
      border-radius: 4px;
      background-color: #f8f9fa;
      max-height: 500px;
      overflow-y: auto;
    }
    /* Tracker Page Styles */
    #trackerPage #trackerContainer {
      max-width: 1200px;
      margin: 0 auto;
    }
    #trackerForm {
      background-color: #fff;
      border: 1px solid #ced4da;
      padding: 15px;
      border-radius: 6px;
      margin-bottom: 20px;
    }
    #trackerForm label {
      display: block;
      margin: 5px 0 2px;
    }
    #trackerForm input, #trackerForm select {
      width: 100%;
      padding: 6px;
      font-size: 14px;
      margin-bottom: 10px;
      border: 1px solid #ced4da;
      border-radius: 4px;
    }
    /* New Tracker Games UI */
    #trackerGamesContainer {
      margin-top: 15px;
      border-top: 1px solid #ced4da;
      padding-top: 15px;
    }
    .game-row {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      margin-bottom: 15px;
      background-color: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 6px;
      padding: 10px;
    }
    .game-row h4 {
      width: 100%;
      margin-bottom: 10px;
      text-align: center;
    }
    .team-picker-slot {
      background-color: #fdfdfe;
      border: 2px dashed #adb5bd;
      width: 150px;
      height: 50px;
      border-radius: 4px;
      position: relative;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
    }
    .team-picker-slot img {
      width: 40px;
      height: 40px;
      margin: 0 2px;
      border-radius: 3px;
    }
    .game-section {
      display: flex;
      gap: 10px;
      align-items: center;
      margin: 5px 0;
      flex-wrap: wrap;
    }
    .winner-select {
      padding: 6px;
      font-size: 14px;
    }
    #saveSetButton {
      padding: 8px 16px;
      font-size: 14px;
      background-color: #28a745;
      border: none;
      color: #fff;
      border-radius: 4px;
      cursor: pointer;
      display: block;
      margin: 0 auto;
    }
    /* Tracker Sets List */
    #trackerTeamsList {
      margin-top: 20px;
    }
    .tracker-set {
      background-color: #f8f9fa;
      border: 1px solid #ced4da;
      border-radius: 4px;
      padding: 10px;
      margin-bottom: 10px;
    }
    .tracker-set p { margin: 4px 0; }
    .tracker-set .team-images img {
      width: 30px;
      height: 30px;
      margin-right: 3px;
      border-radius: 3px;
    }
    .tracker-set button.delete-btn {
      padding: 4px 8px;
      font-size: 12px;
      background-color: #dc3545;
      border: none;
      color: #fff;
      border-radius: 4px;
      cursor: pointer;
      margin-left: 5px;
    }
    /* Stats Page */
    #statsPage .pane {
      max-width: 1000px;
      margin: 0 auto 20px;
    }
    #statsControls {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-bottom: 10px;
      align-items: center;
    }
    #statsControls input[type="file"] {
      margin-top: 10px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
    }
    table th, table td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
    }
    table th {
      background-color: #e9ecef;
    }
  </style>
</head>
<body>
  <header>
    <button id="btnBuilder" class="active">Team Builder</button>
    <button id="btnTracker">Team Tracker</button>
    <button id="btnStats">Statistics</button>
  </header>

  <!-- Ban List Section -->
  <div id="banListContainer">
    <div id="banListHeader">
      <h2>Ban List Input</h2>
      <button id="toggleBanList">Collapse</button>
    </div>
    <div id="banListContent">
      <textarea id="banList" placeholder="Paste your ban list here (one rule per line)"></textarea>
      <button id="applyBanList">Apply Ban List</button>
    </div>
  </div>

  <!-- Import Section for Characters JSON -->
  <div id="importSection">
    <label for="jsonFile">Import Characters JSON:</label>
    <input type="file" id="jsonFile" accept=".json">
    <br>
    <button id="loadJsonButton">Load Characters</button>
  </div>

  <!-- Global Available Characters Panel -->
  <div id="globalCharactersPanel">
    <h2>Available Characters</h2>
    <div id="filterBox">
      <input type="text" id="filterInput" placeholder="Filter by name, energy, class...">
    </div>
    <div id="charactersList"></div>
  </div>

  <!-- Modal for Character Picker in Tracker -->
  <div id="characterPickerModal">
    <div class="modal-content">
      <h3>Select 3 Characters</h3>
      <!-- New search input for filtering characters -->
      <input type="text" id="pickerFilter" placeholder="Search characters...">
      <div id="pickerGrid" class="picker-grid"></div>
      <div class="modal-buttons">
        <button id="confirmPicker">Confirm</button>
        <button id="cancelPicker">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Container for Pages -->
  <div id="pagesContainer">
    <!-- Page: Team Builder -->
    <div id="builderPage" class="page active">
      <div id="mainContainer">
        <!-- Team Assembly Pane -->
        <div id="teamArea" class="pane">
          <h2>Your Team (Drag or doubleâ€‘click 3 characters)</h2>
          <div id="teamSlots">
            <div class="team-slot" data-slot="0"></div>
            <div class="team-slot" data-slot="1"></div>
            <div class="team-slot" data-slot="2"></div>
          </div>
          <button id="checkTeamButton">Check if Team is Valid</button>
          <div id="validationReport"></div>
          <div id="tagSummary">
            <h3>Team Skill Tags</h3>
            <div id="tagsDisplay"></div>
          </div>
        </div>
        <!-- Character Details Pane -->
        <div id="detailsPane" class="pane">
          <h2>Character Details</h2>
          <div id="detailsDisplay">Click on a character to see details.</div>
        </div>
      </div>
    </div>

    <!-- Page: Team Tracker -->
    <div id="trackerPage" class="page">
      <div id="trackerContainer">
        <h2>Team Tracker (Best of 5)</h2>
        <div id="trackerForm" class="pane">
          <label for="eventName">Event Name:</label>
          <input type="text" id="eventName" placeholder="e.g., Supreme Championship 11">
          <label for="clanName">Your Clan:</label>
          <input type="text" id="clanName" placeholder="e.g., Legends Rebirth">
          <label for="opponentClan">Opponent Clan:</label>
          <input type="text" id="opponentClan" placeholder="e.g., Arise">
          <label for="playerName">Your Player Name:</label>
          <input type="text" id="playerName" placeholder="e.g., Zonanorte">
          <label for="opponentPlayerName">Opponent Player Name:</label>
          <input type="text" id="opponentPlayerName" placeholder="e.g., Cabra">
          
          <div id="trackerGamesContainer">
            <!-- Dynamically created game rows -->
          </div>
          <button id="saveSetButton">Save Set</button>
        </div>
        <div id="trackerTeamsList" class="pane">
          <h3>Saved Sets</h3>
          <div>
            <label for="filterEvent">Filter by Event:</label>
            <input type="text" id="filterEvent" placeholder="Event name">
            <label for="filterClan">Filter by Clan:</label>
            <input type="text" id="filterClan" placeholder="Clan">
            <button id="applyTrackerFilter" style="padding:4px 8px;">Apply Filter</button>
            <button id="clearTrackerFilter" style="padding:4px 8px;">Clear Filter</button>
          </div>
          <div id="trackerTeamsContainer"></div>
        </div>
      </div>
    </div>

    <!-- Page: Statistics -->
    <div id="statsPage" class="page">
      <div class="pane">
        <h2>Statistics</h2>
        <div id="statsControls">
          <button id="exportStatsButton">Export Stats Data</button>
          <input type="file" id="statsFile" accept=".json">
          <button id="importStatsButton">Import Stats Data</button>
          <button id="clearAllStatsButton">Clear All Stats</button>
          <label style="display: inline-block; margin-left: 10px;">
            <input type="checkbox" id="sortByWinRateCheckbox"> Sort by Win Rate
          </label>
        </div>
        <div id="statsOutput"></div>
      </div>
    </div>
  </div>

  <script>
    /***** Global Variables *****/
    let characters = [];
    let currentTeam = [null, null, null];  // For Team Builder
    let appliedBanList = [];
    let savedMatchSets = JSON.parse(localStorage.getItem("savedMatchSets")) || []; 
    // For the modal picker
    let pickerCallback = null;
    let pickerContext = {}; // { game, side }
    let selectedPickerChars = [];

    // Only these tags trigger team invalidity if present at 3/3
    const criticalTags = ["Heal", "Stun", "Affliction", "AoE", "Counter", "Remove Chakra", "Steal Chakra"];
    const tagRules = [
      { keyword: "stun", tag: "Stun" },
      { keyword: "heal", tag: "Heal" },
      { keyword: "afflict", tag: "Affliction" },
      { keyword: "aoe", tag: "AoE" },
      { keyword: "area", tag: "AoE" },
      { keyword: "counter", tag: "Counter" },
      { keyword: "remove chakra", tag: "Remove Chakra" },
      { keyword: "lose chakra", tag: "Remove Chakra" },
      { keyword: "steal chakra", tag: "Steal Chakra" },
      { keyword: "drain", tag: "Steal Chakra" },
      { keyword: "piercing", tag: "Piercing Damage" },
      { keyword: "increased damage", tag: "Increased Damage" },
      { keyword: "destructible defense", tag: "Destructible Defense" },
      { keyword: "damage reduction", tag: "Damage Reduction" },
      { keyword: "invulnerable", tag: "Invulnerable" },
      { keyword: "copy", tag: "Copy" },
      { keyword: "invisible", tag: "Invisible" },
      { keyword: "duration", tag: "Duration Modifier" }
    ];

    /***** Navigation between Pages *****/
    const btnBuilder = document.getElementById('btnBuilder');
    const btnTracker = document.getElementById('btnTracker');
    const btnStats   = document.getElementById('btnStats');
    const builderPage= document.getElementById('builderPage');
    const trackerPage= document.getElementById('trackerPage');
    const statsPage  = document.getElementById('statsPage');

    btnBuilder.addEventListener('click', () => {
      builderPage.classList.add('active');
      trackerPage.classList.remove('active');
      statsPage.classList.remove('active');
      btnBuilder.classList.add('active');
      btnTracker.classList.remove('active');
      btnStats.classList.remove('active');
    });
    btnTracker.addEventListener('click', () => {
      trackerPage.classList.add('active');
      builderPage.classList.remove('active');
      statsPage.classList.remove('active');
      btnTracker.classList.add('active');
      btnBuilder.classList.remove('active');
      btnStats.classList.remove('active');
      renderTrackerTeams();
    });
    btnStats.addEventListener('click', () => {
      statsPage.classList.add('active');
      trackerPage.classList.remove('active');
      builderPage.classList.remove('active');
      btnStats.classList.add('active');
      btnTracker.classList.remove('active');
      btnBuilder.classList.remove('active');
      renderStats();
    });

    /***** Ban List Functionality *****/
    document.getElementById('toggleBanList').addEventListener('click', () => {
      const content = document.getElementById('banListContent');
      const btn = document.getElementById('toggleBanList');
      if (content.style.display === "none") {
        content.style.display = "block";
        btn.textContent = "Collapse";
      } else {
        content.style.display = "none";
        btn.textContent = "Expand";
      }
    });
    document.getElementById('applyBanList').addEventListener('click', () => {
      const banText = document.getElementById('banList').value;
      appliedBanList = banText.split('\n').map(line => line.trim()).filter(line => line.length > 0);
      document.getElementById('banListContent').style.display = "none";
      document.getElementById('toggleBanList').textContent = "Expand";
      checkTeamValidity();
    });

    /***** Import Characters JSON *****/
    document.getElementById('loadJsonButton').addEventListener('click', () => {
      const fileInput = document.getElementById('jsonFile');
      const file = fileInput.files[0];
      if (!file) {
        alert("Please choose a JSON file first.");
        return;
      }
      const reader = new FileReader();
      reader.onload = function(event) {
        try {
          const jsonData = JSON.parse(event.target.result);
          characters = Array.isArray(jsonData) ? jsonData : (jsonData.characters && Array.isArray(jsonData.characters) ? jsonData.characters : []);
          if (characters.length === 0) {
            alert("No character data found. Please check your JSON file format.");
          } else {
            renderCharacters();
          }
        } catch (err) {
          console.error("Error parsing JSON file:", err);
          alert("Failed to parse JSON file. Please check its format.");
        }
      };
      reader.readAsText(file);
    });

    /***** Render Global Available Characters *****/
    function renderCharacters() {
      const listDiv = document.getElementById('charactersList');
      const filterVal = document.getElementById('filterInput').value.toLowerCase();
      listDiv.innerHTML = '';
      characters.forEach((char, index) => {
        const nameMatch = char.name.toLowerCase().includes(filterVal);
        const energyMatch = char.skills.some(skill => skill.energy.some(e => e.toLowerCase().includes(filterVal)));
        const classMatch = char.skills.some(skill => skill.classes.some(cls => cls.toLowerCase().includes(filterVal)));
        if (filterVal === "" || nameMatch || energyMatch || classMatch) {
          const charDiv = document.createElement('div');
          charDiv.className = 'character';
          charDiv.draggable = true;
          charDiv.dataset.index = index;
          charDiv.innerHTML = `<img src="${char.url}" alt="${char.name}">` + (builderPage.classList.contains('active') ? `<span>${char.name}</span>` : "");
          charDiv.addEventListener('click', () => showCharacterDetails(char));
          charDiv.addEventListener('dblclick', () => { 
            if(builderPage.classList.contains('active')) {
              addToTeam(char);
            }
          });
          listDiv.appendChild(charDiv);
        }
      });
      setupDragDrop();
    }
    document.getElementById('filterInput').addEventListener('input', renderCharacters);

    /***** Team Builder Functions *****/
    function addToTeam(char) {
      for (let i = 0; i < currentTeam.length; i++) {
        if (!currentTeam[i]) {
          currentTeam[i] = char;
          const slot = document.querySelector(`.team-slot[data-slot="${i}"]`);
          slot.innerHTML = `<img src="${char.url}" alt="${char.name}">` +
                             `<button class="remove-btn" onclick="removeFromTeam(${i})">Ã—</button>`;
          updateTagSummary();
          return;
        }
      }
      alert("Team is already full.");
    }
    function removeFromTeam(slotIndex) {
      currentTeam[slotIndex] = null;
      const slot = document.querySelector(`.team-slot[data-slot="${slotIndex}"]`);
      if (slot) { slot.innerHTML = ""; }
      updateTagSummary();
    }
    function updateTagSummary() {
      const tagCounts = {};
      currentTeam.forEach(char => {
        if (char) {
          const charTags = new Set();
          char.skills.forEach(skill => {
            tagRules.forEach(rule => {
              if (skill.description.toLowerCase().includes(rule.keyword.toLowerCase())) {
                charTags.add(rule.tag);
              }
            });
          });
          charTags.forEach(tag => {
            tagCounts[tag] = (tagCounts[tag] || 0) + 1;
          });
        }
      });
      const displayDiv = document.getElementById('tagsDisplay');
      displayDiv.innerHTML = '';
      Object.keys(tagCounts).forEach(tag => {
        if (criticalTags.includes(tag) && tagCounts[tag] >= 3) {
          const p = document.createElement('p');
          p.className = 'tag';
          p.textContent = `${tag} Skills: ${tagCounts[tag]} / 3  â€” TOO MANY!`;
          displayDiv.appendChild(p);
        } else if (tagCounts[tag] > 0) {
          const p = document.createElement('p');
          p.className = 'tag';
          p.textContent = `${tag} Skills: ${tagCounts[tag]} / 3`;
          displayDiv.appendChild(p);
        }
      });
    }
    document.getElementById('checkTeamButton').addEventListener('click', checkTeamValidity);
    function checkTeamValidity() {
      let report = "";
      if (currentTeam.some(char => char === null)) {
        report += "Please fill all 3 team slots.\n";
      }
      currentTeam.forEach(char => {
        if (char) {
          appliedBanList.forEach(rule => {
            if (char.name.toLowerCase().includes(rule.toLowerCase())) {
              report += `Ban rule triggered: "${rule}" found in ${char.name}\n`;
            }
          });
        }
      });
      // Validate only critical tags
      const tagCounts = {};
      currentTeam.forEach(char => {
        if (char) {
          const charTags = new Set();
          char.skills.forEach(skill => {
            tagRules.forEach(rule => {
              if (skill.description.toLowerCase().includes(rule.keyword.toLowerCase())) {
                charTags.add(rule.tag);
              }
            });
          });
          charTags.forEach(tag => {
            tagCounts[tag] = (tagCounts[tag] || 0) + 1;
          });
        }
      });
      Object.keys(tagCounts).forEach(tag => {
        if (criticalTags.includes(tag) && tagCounts[tag] >= 3) {
          report += `Team has too many ${tag} skills: ${tagCounts[tag]} (max allowed: 2)\n`;
        }
      });
      document.getElementById('validationReport').textContent = report === "" ? "Team is valid!" : report;
    }

    /***** Drag and Drop Setup *****/
    function setupDragDrop() {
      const charactersList = document.getElementById('charactersList');
      charactersList.addEventListener('dragstart', e => {
        if (e.target.classList.contains('character')) {
          e.dataTransfer.setData('text/plain', e.target.dataset.index);
        }
      });
      const builderSlots = document.querySelectorAll('.team-slot');
      builderSlots.forEach(slot => {
        slot.addEventListener('dragover', e => {
          e.preventDefault();
          slot.classList.add('over');
        });
        slot.addEventListener('dragleave', () => { slot.classList.remove('over'); });
        slot.addEventListener('drop', e => {
          e.preventDefault();
          slot.classList.remove('over');
          const charIndex = e.dataTransfer.getData('text/plain');
          if (characters[charIndex]) {
            const slotIndex = slot.dataset.slot;
            currentTeam[slotIndex] = characters[charIndex];
            slot.innerHTML = `<img src="${characters[charIndex].url}" alt="${characters[charIndex].name}">` +
                             `<button class="remove-btn" onclick="removeFromTeam(${slotIndex})">Ã—</button>`;
            updateTagSummary();
          }
        });
      });
    }

    /***** Character Details *****/
    function showCharacterDetails(char) {
      let tags = {};
      char.skills.forEach(skill => {
        tagRules.forEach(rule => {
          if (skill.description.toLowerCase().includes(rule.keyword.toLowerCase())) {
            tags[rule.tag] = true;
          }
        });
      });
      let detailsHtml = `<strong>Name:</strong> ${char.name}<br><br>
                         <strong>Description:</strong><br>${char.description}<br><br>
                         <strong>Skills:</strong><br>`;
      char.skills.forEach(skill => {
        detailsHtml += `<div style="margin-bottom:10px; border-bottom:1px solid #ced4da; padding-bottom:8px;">
                          <img src="${skill.url}" alt="${skill.name}" style="width:30px;height:30px;vertical-align:middle;margin-right:8px; border-radius:3px;">
                          <strong>${skill.name}</strong><br>
                          ${skill.description}<br>
                          <em>Energy:</em> ${skill.energy.join(", ")}<br>
                          <em>Classes:</em> ${skill.classes.join(", ")}<br>
                          <em>Cooldown:</em> ${skill.cooldown}
                        </div>`;
      });
      detailsHtml += `<strong>Skill Tags:</strong> ${Object.keys(tags).join(", ")}`;
      document.getElementById('detailsDisplay').innerHTML = detailsHtml;
    }

    /***** Tracker Page Functions *****/
    function initTrackerGamesUI() {
      const container = document.getElementById("trackerGamesContainer");
      container.innerHTML = "";
      for (let g = 0; g < 5; g++) {
        const rowDiv = document.createElement("div");
        rowDiv.className = "game-row";
        rowDiv.dataset.gameIndex = g;
        const title = document.createElement("h4");
        title.textContent = `Game ${g+1}`;
        rowDiv.appendChild(title);

        // Ally team box
        const allySection = document.createElement("div");
        allySection.className = "game-section";
        allySection.innerHTML = `<strong>Your Team:</strong>`;
        const allySlot = document.createElement("div");
        allySlot.className = "team-picker-slot";
        allySlot.dataset.game = g;
        allySlot.dataset.player = "ally";
        allySlot.innerHTML = "Double-click to set team";
        allySlot.addEventListener('dblclick', () => {
          openTeamPicker(g, "ally");
        });
        allySection.appendChild(allySlot);
        rowDiv.appendChild(allySection);

        // Opponent team box
        const oppSection = document.createElement("div");
        oppSection.className = "game-section";
        oppSection.innerHTML = `<strong>Opponent Team:</strong>`;
        const oppSlot = document.createElement("div");
        oppSlot.className = "team-picker-slot";
        oppSlot.dataset.game = g;
        oppSlot.dataset.player = "opp";
        oppSlot.innerHTML = "Double-click to set team";
        oppSlot.addEventListener('dblclick', () => {
          openTeamPicker(g, "opp");
        });
        oppSection.appendChild(oppSlot);
        rowDiv.appendChild(oppSection);

        // Winner select
        const winnerSection = document.createElement("div");
        winnerSection.className = "game-section";
        winnerSection.innerHTML = `<strong>Winner:</strong>`;
        const sel = document.createElement("select");
        sel.className = "winner-select";
        sel.dataset.game = g;
        sel.innerHTML = `<option value="">--</option>
                         <option value="player1">You</option>
                         <option value="player2">Opponent</option>`;
        winnerSection.appendChild(sel);
        rowDiv.appendChild(winnerSection);

        container.appendChild(rowDiv);
      }
    }
    initTrackerGamesUI();

    // Function to render the character picker grid based on filter text
    function renderPickerGrid(filterText) {
      const grid = document.getElementById("pickerGrid");
      grid.innerHTML = "";
      characters.forEach((char, index) => {
        if (char.name.toLowerCase().includes(filterText.toLowerCase())) {
          const div = document.createElement("div");
          div.className = "picker-item";
          div.dataset.index = index;
          div.innerHTML = `<img src="${char.url}" alt="${char.name}" style="width:40px;height:40px;border-radius:3px;">`;
          if (selectedPickerChars.includes(index)) {
            div.classList.add("selected");
          }
          div.addEventListener("click", () => {
            if (selectedPickerChars.includes(index)) {
              selectedPickerChars = selectedPickerChars.filter(i => i !== index);
              div.classList.remove("selected");
            } else {
              if (selectedPickerChars.length < 3) {
                selectedPickerChars.push(index);
                div.classList.add("selected");
              } else {
                alert("You can only select 3 characters.");
              }
            }
          });
          grid.appendChild(div);
        }
      });
    }

    // Open the team picker modal for the tracker tab
    function openTeamPicker(game, side) {
      pickerContext = { game, side };
      selectedPickerChars = [];
      document.getElementById("pickerFilter").value = "";
      renderPickerGrid("");
      document.getElementById("characterPickerModal").style.display = "flex";
    }

    // Event listener for filtering characters in the picker modal
    document.getElementById("pickerFilter").addEventListener("input", (e) => {
      renderPickerGrid(e.target.value);
    });

    document.getElementById("confirmPicker").addEventListener("click", () => {
      if (selectedPickerChars.length !== 3) {
        alert("Please select exactly 3 characters.");
        return;
      }
      const team = selectedPickerChars.map(i => characters[i]);
      const selector = `.team-picker-slot[data-game="${pickerContext.game}"][data-player="${pickerContext.side}"]`;
      const slot = document.querySelector(selector);
      if (slot) {
        slot.innerHTML = "";
        team.forEach(char => {
          slot.innerHTML += `<img src="${char.url}" alt="${char.name}">`;
        });
      }
      document.getElementById("characterPickerModal").style.display = "none";
    });
    document.getElementById("cancelPicker").addEventListener("click", () => {
      document.getElementById("characterPickerModal").style.display = "none";
    });

    /***** Tracker Set Saving and Rendering *****/
    document.getElementById('saveSetButton').addEventListener('click', saveTrackerSet);
    function saveTrackerSet() {
      const eventName = document.getElementById('eventName').value.trim();
      const clanName = document.getElementById('clanName').value.trim();
      const oppClan = document.getElementById('opponentClan').value.trim();
      const playerName = document.getElementById('playerName').value.trim();
      const oppPlayerName = document.getElementById('opponentPlayerName').value.trim();
      if (!eventName || !clanName || !oppClan || !playerName || !oppPlayerName) {
        alert("Please fill out event/clan/player fields.");
        return;
      }
      const setObj = {
        event: eventName,
        clan1: clanName,
        clan2: oppClan,
        player1: playerName,
        player2: oppPlayerName,
        games: []
      };
      for (let g = 0; g < 5; g++) {
        const gameData = { allyTeam: [], oppTeam: [], winner: "" };
        const allyDiv = document.querySelector(`.team-picker-slot[data-game="${g}"][data-player="ally"]`);
        if (allyDiv && allyDiv.querySelectorAll("img").length === 3) {
          allyDiv.querySelectorAll("img").forEach(img => {
            const found = characters.find(c => c.url === img.src);
            gameData.allyTeam.push(found || { name: "Unknown", url: img.src });
          });
        }
        const oppDiv = document.querySelector(`.team-picker-slot[data-game="${g}"][data-player="opp"]`);
        if (oppDiv && oppDiv.querySelectorAll("img").length === 3) {
          oppDiv.querySelectorAll("img").forEach(img => {
            const found = characters.find(c => c.url === img.src);
            gameData.oppTeam.push(found || { name: "Unknown", url: img.src });
          });
        }
        const sel = document.querySelector(`select.winner-select[data-game="${g}"]`);
        if (sel) {
          gameData.winner = sel.value;
        }
        setObj.games.push(gameData);
      }
      let p1Wins = 0, p2Wins = 0;
      setObj.games.forEach(game => {
        if (game.winner === "player1") p1Wins++;
        else if (game.winner === "player2") p2Wins++;
      });
      setObj.finalSetWinner = p1Wins >= 3 ? "player1" : (p2Wins >= 3 ? "player2" : "");
      savedMatchSets.push(setObj);
      localStorage.setItem("savedMatchSets", JSON.stringify(savedMatchSets));
      alert("Set saved!");
      initTrackerGamesUI();
      document.getElementById('eventName').value = "";
      document.getElementById('clanName').value = "";
      document.getElementById('opponentClan').value = "";
      document.getElementById('playerName').value = "";
      document.getElementById('opponentPlayerName').value = "";
      renderTrackerTeams();
    }
    function renderTrackerTeams() {
      const eventFilter = document.getElementById('filterEvent').value.toLowerCase();
      const clanFilter  = document.getElementById('filterClan').value.toLowerCase();
      const container   = document.getElementById('trackerTeamsContainer');
      container.innerHTML = "";
      const filteredSets = savedMatchSets.filter(setObj => {
        const evtMatch = !eventFilter || setObj.event.toLowerCase().includes(eventFilter);
        const clanMatch= !clanFilter || setObj.clan1.toLowerCase().includes(clanFilter) || setObj.clan2.toLowerCase().includes(clanFilter);
        return evtMatch && clanMatch;
      });
      if (filteredSets.length === 0) {
        container.innerHTML = "<p>No sets saved matching the filter.</p>";
        return;
      }
      filteredSets.forEach((setObj, idx) => {
        const div = document.createElement('div');
        div.className = 'tracker-set';
        let gamesHtml = "";
        setObj.games.forEach((game, gi) => {
          if ((game.allyTeam && game.allyTeam.length === 3) && (game.oppTeam && game.oppTeam.length === 3)) {
            let allyImgs = game.allyTeam.map(c => (c && c.url) ? `<img src="${c.url}" alt="${c.name}">` : "").join("");
            let oppImgs = game.oppTeam.map(c => (c && c.url) ? `<img src="${c.url}" alt="${c.name}">` : "").join("");
            gamesHtml += `<p><strong>Game ${gi+1}:</strong> Your Team: <span class="team-images">${allyImgs}</span> vs Opponent Team: <span class="team-images">${oppImgs}</span> | Winner: ${game.winner || "--"}</p>`;
          }
        });
        div.innerHTML = `
          <p><strong>Event:</strong> ${setObj.event}</p>
          <p><strong>Clans:</strong> ${setObj.clan1} vs ${setObj.clan2}</p>
          <p><strong>Players:</strong> ${setObj.player1} vs ${setObj.player2}</p>
          <p><strong>Final Set Winner:</strong> ${setObj.finalSetWinner || "Undecided"}</p>
          ${gamesHtml}
          <button class="delete-btn" onclick="deleteTrackerSet(${savedMatchSets.indexOf(setObj)})">Delete Set</button>
        `;
        container.appendChild(div);
      });
    }
    document.getElementById('applyTrackerFilter').addEventListener('click', renderTrackerTeams);
    document.getElementById('clearTrackerFilter').addEventListener('click', () => {
      document.getElementById('filterEvent').value = "";
      document.getElementById('filterClan').value = "";
      renderTrackerTeams();
    });
    function deleteTrackerSet(index) {
      if (confirm("Are you sure you want to delete this set entry?")) {
        savedMatchSets.splice(index, 1);
        localStorage.setItem("savedMatchSets", JSON.stringify(savedMatchSets));
        renderTrackerTeams();
      }
    }

    /***** Statistics Functions *****/
    const statsOutput = document.getElementById('statsOutput');
    document.getElementById('exportStatsButton').addEventListener('click', exportStatsData);
    document.getElementById('importStatsButton').addEventListener('click', importStatsData);
    document.getElementById('clearAllStatsButton').addEventListener('click', clearAllStats);
    // Re-render stats when the sort checkbox is toggled.
    document.getElementById('sortByWinRateCheckbox').addEventListener('change', renderStats);
    function exportStatsData() {
      const dataStr = JSON.stringify(savedMatchSets, null, 2);
      const blob = new Blob([dataStr], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "war_manager_stats.json";
      a.click();
      URL.revokeObjectURL(url);
    }
    function importStatsData() {
      const fileInput = document.getElementById('statsFile');
      const file = fileInput.files[0];
      if (!file) {
        alert("Please choose a JSON file for stats first.");
        return;
      }
      const reader = new FileReader();
      reader.onload = function(event) {
        try {
          const imported = JSON.parse(event.target.result);
          if (!Array.isArray(imported)) {
            alert("Invalid stats data format. Expected an array.");
            return;
          }
          savedMatchSets = imported;
          localStorage.setItem("savedMatchSets", JSON.stringify(savedMatchSets));
          alert("Stats data imported and stored. Rendering stats...");
          renderStats();
        } catch (err) {
          console.error("Error parsing Stats JSON file:", err);
          alert("Error parsing Stats JSON file: " + err);
        }
      };
      reader.readAsText(file);
    }
    function clearAllStats() {
      if (!confirm("Are you sure you want to clear all stats? This cannot be undone.")) return;
      savedMatchSets = [];
      localStorage.removeItem("savedMatchSets");
      alert("All stats cleared.");
      renderStats();
    }
    function renderStats() {
      statsOutput.innerHTML = "";
      if (!Array.isArray(savedMatchSets) || savedMatchSets.length === 0) {
        statsOutput.innerHTML = "<p>No match data to show. Import or create some sets first.</p>";
        return;
      }
      // Determine sort mode based on checkbox
      const sortByWinRate = document.getElementById('sortByWinRateCheckbox').checked;

      const playerStats = {};
      const charStats = {};
      const teamStats = {};
      const combo2Stats = {};

      function tripleKey(arr) {
        const names = arr.filter(c => c && c.name).map(c => c.name);
        const sorted = names.sort((a, b) => a.toLowerCase().localeCompare(b.toLowerCase()));
        return sorted.join(" | ");
      }
      function pairCombosFromTeam(teamArr) {
        const names = teamArr.filter(c => c && c.name).map(c => c.name).sort();
        let combos = [];
        for (let i = 0; i < names.length; i++) {
          for (let j = i+1; j < names.length; j++) {
            combos.push(`${names[i]} & ${names[j]}`);
          }
        }
        return combos;
      }
      savedMatchSets.forEach(setObj => {
        let p1Wins = 0, p2Wins = 0;
        setObj.games.forEach(game => {
          if (game.winner === "player1") p1Wins++;
          else if (game.winner === "player2") p2Wins++;
          const ally = game.allyTeam || [];
          const opp = game.oppTeam || [];
          ally.forEach(c => {
            if (c && c.name) {
              if (!charStats[c.name]) charStats[c.name] = { used: 0, wins: 0 };
              charStats[c.name].used++;
            }
          });
          opp.forEach(c => {
            if (c && c.name) {
              if (!charStats[c.name]) charStats[c.name] = { used: 0, wins: 0 };
              charStats[c.name].used++;
            }
          });
          const winningTeam = game.winner === "player1" ? ally : (game.winner === "player2" ? opp : []);
          winningTeam.forEach(c => {
            if (c && c.name) {
              if (!charStats[c.name]) charStats[c.name] = { used: 0, wins: 0 };
              charStats[c.name].wins++;
            }
          });
          if (ally.length === 3) {
            const key = tripleKey(ally);
            if (!teamStats[key]) teamStats[key] = { played: 0, wins: 0, team: ally };
            teamStats[key].played++;
            if (game.winner === "player1") teamStats[key].wins++;
            const pairs = pairCombosFromTeam(ally);
            pairs.forEach(pKey => {
              if (!combo2Stats[pKey]) combo2Stats[pKey] = { usage: 0, wins: 0 };
              combo2Stats[pKey].usage++;
              if (game.winner === "player1") combo2Stats[pKey].wins++;
            });
          }
          if (opp.length === 3) {
            const key = tripleKey(opp);
            if (!teamStats[key]) teamStats[key] = { played: 0, wins: 0, team: opp };
            teamStats[key].played++;
            if (game.winner === "player2") teamStats[key].wins++;
            const pairs = pairCombosFromTeam(opp);
            pairs.forEach(pKey => {
              if (!combo2Stats[pKey]) combo2Stats[pKey] = { usage: 0, wins: 0 };
              combo2Stats[pKey].usage++;
              if (game.winner === "player2") combo2Stats[pKey].wins++;
            });
          }
        });
        if (setObj.player1) {
          if (!playerStats[setObj.player1]) playerStats[setObj.player1] = { setsPlayed: 0, setsWon: 0 };
          playerStats[setObj.player1].setsPlayed++;
        }
        if (setObj.player2) {
          if (!playerStats[setObj.player2]) playerStats[setObj.player2] = { setsPlayed: 0, setsWon: 0 };
          playerStats[setObj.player2].setsPlayed++;
        }
        if (p1Wins >= 3 && setObj.player1) playerStats[setObj.player1].setsWon++;
        if (p2Wins >= 3 && setObj.player2) playerStats[setObj.player2].setsWon++;
      });

      let html = "";

      // Player Set Win Rates
      html += `<h3>Player Set Win Rates</h3>`;
      html += `<table><tr><th>Player</th><th>Sets Played</th><th>Sets Won</th><th>Win Rate</th></tr>`;
      let playersArr = Object.keys(playerStats).map(p => {
        let ps = playerStats[p];
        let winRate = ps.setsPlayed > 0 ? (ps.setsWon / ps.setsPlayed) : 0;
        return {name: p, setsPlayed: ps.setsPlayed, setsWon: ps.setsWon, winRate: winRate};
      });
      if (sortByWinRate) {
        playersArr.sort((a, b) => b.winRate - a.winRate);
      }
      playersArr.forEach(p => {
        let rate = p.setsPlayed > 0 ? ((p.winRate)*100).toFixed(1) + "%" : "0%";
        html += `<tr><td>${p.name}</td><td>${p.setsPlayed}</td><td>${p.setsWon}</td><td>${rate}</td></tr>`;
      });
      html += `</table>`;

      // Character Win Rates
      html += `<h3>Character Win Rates</h3>`;
      html += `<table><tr><th>Character</th><th>Sets Used</th><th>Wins</th><th>Win Rate</th></tr>`;
      let charsArr = Object.keys(charStats).map(ch => {
        let st = charStats[ch];
        let winRate = st.used > 0 ? (st.wins / st.used) : 0;
        return {name: ch, used: st.used, wins: st.wins, winRate: winRate};
      });
      if (sortByWinRate) {
        charsArr.sort((a, b) => b.winRate - a.winRate);
      } else {
        // Default: sort by usage descending.
        charsArr.sort((a, b) => b.used - a.used);
      }
      charsArr.forEach(ch => {
        let rate = ch.used > 0 ? ((ch.winRate)*100).toFixed(1) + "%" : "0%";
        let charObj = characters.find(c => c.name === ch.name);
        let imgTag = charObj ? `<img src="${charObj.url}" alt="${ch.name}" style="width:30px;height:30px;border-radius:3px;">` : "";
        html += `<tr><td>${imgTag}</td><td>${ch.used}</td><td>${ch.wins}</td><td>${rate}</td></tr>`;
      });
      html += `</table>`;

      // Full Team Win Rates
      html += `<h3>Full Team Win Rates</h3>`;
      html += `<table><tr><th>Team</th><th>Sets Played</th><th>Wins</th><th>Win Rate</th></tr>`;
      let teamsArr = Object.keys(teamStats).map(tm => {
        let ts = teamStats[tm];
        let winRate = ts.played > 0 ? (ts.wins / ts.played) : 0;
        return {key: tm, played: ts.played, wins: ts.wins, winRate: winRate, team: ts.team};
      });
      if (sortByWinRate) {
        teamsArr.sort((a, b) => b.winRate - a.winRate);
      } else {
        teamsArr.sort((a, b) => b.played - a.played);
      }
      teamsArr.forEach(tm => {
        let rate = tm.played > 0 ? ((tm.winRate)*100).toFixed(1) + "%" : "0%";
        let teamImgs = tm.team.map(c => (c && c.url) ? `<img src="${c.url}" alt="${c.name}" style="width:30px;height:30px;border-radius:3px;margin-right:3px;">` : "").join("");
        html += `<tr><td>${teamImgs}</td><td>${tm.played}</td><td>${tm.wins}</td><td>${rate}</td></tr>`;
      });
      html += `</table>`;

      // Twoâ€‘Character Combo Stats
      html += `<h3>Twoâ€‘Character Combo Stats</h3>`;
      html += `<table><tr><th>Combo</th><th>Usage</th><th>Wins</th><th>Win Rate</th></tr>`;
      let combosArr = Object.keys(combo2Stats).map(cb => {
        let cs = combo2Stats[cb];
        let winRate = cs.usage > 0 ? (cs.wins / cs.usage) : 0;
        return {combo: cb, usage: cs.usage, wins: cs.wins, winRate: winRate};
      });
      if (sortByWinRate) {
        combosArr.sort((a, b) => b.winRate - a.winRate);
      } else {
        combosArr.sort((a, b) => b.usage - a.usage);
      }
      combosArr.forEach(item => {
        let rate = item.usage > 0 ? ((item.winRate)*100).toFixed(1) + "%" : "0%";
        // Instead of text, show images for each character in the combo.
        let names = item.combo.split(" & ");
        let comboImgHtml = names.map(name => {
          let charObj = characters.find(c => c.name === name);
          return charObj ? `<img src="${charObj.url}" alt="${name}" style="width:30px;height:30px;border-radius:3px;margin-right:3px;">` : `<span>${name}</span>`;
        }).join("");
        html += `<tr><td>${comboImgHtml}</td><td>${item.usage}</td><td>${item.wins}</td><td>${rate}</td></tr>`;
      });
      html += `</table>`;

      statsOutput.innerHTML = html;
    }

    /***** On Load *****/
    initTrackerGamesUI();
    if (characters.length > 0) {
      renderCharacters();
    }
  </script>
</body>
</html>
