<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Naruto-Arena Clan War Tracker</title>
  <style>
    /* Global Styles */
    body {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f0f2f5;
      margin: 0;
      padding: 20px;
      color: #333;
    }
    header {
      text-align: center;
      margin-bottom: 20px;
    }
    header button {
      padding: 10px 20px;
      margin: 0 5px;
      border: none;
      border-radius: 4px;
      background-color: #007bff;
      color: white;
      cursor: pointer;
    }
    header button.active {
      background-color: #0056b3;
    }
    .page {
      display: none;
    }
    .page.active {
      display: block;
    }
    /* Form and Container Styling */
    form {
      max-width: 800px;
      margin: 0 auto;
      background: #fff;
      padding: 15px;
      border: 1px solid #ced4da;
      border-radius: 6px;
    }
    form label {
      display: block;
      margin: 8px 0 4px;
    }
    form input, form select, form textarea {
      width: 100%;
      padding: 8px;
      margin-bottom: 10px;
      border: 1px solid #ced4da;
      border-radius: 4px;
    }
    button {
      cursor: pointer;
    }
    /* Table Styling */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
    }
    table, th, td {
      border: 1px solid #ccc;
    }
    th, td {
      padding: 8px;
      text-align: left;
    }
    th {
      background-color: #e9ecef;
    }
    /* Modal for Character Picker */
    #characterPickerModal {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    #characterPickerModal .modal-content {
      background: #fff;
      padding: 20px;
      border-radius: 6px;
      max-width: 600px;
      width: 90%;
      max-height: 80%;
      overflow-y: auto;
    }
    #pickerGrid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
      gap: 10px;
      margin: 10px 0;
    }
    .picker-item {
      border: 2px solid transparent;
      border-radius: 4px;
      padding: 5px;
      cursor: pointer;
      transition: border 0.2s;
      text-align: center;
    }
    .picker-item.selected {
      border: 2px solid #28a745;
    }
    .picker-item img {
      width: 40px;
      height: 40px;
      border-radius: 3px;
      display: block;
      margin: 0 auto;
    }
    /* Simple list styling for Manage page */
    .item-list {
      list-style-type: none;
      padding: 0;
    }
    .item-list li {
      padding: 5px;
      border-bottom: 1px solid #ccc;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <!-- Header Navigation -->
  <header>
    <button id="btnMatchEntry" class="active">Match Entry</button>
    <button id="btnImportLogs">Import Logs</button>
    <button id="btnStats">Statistics</button>
    <button id="btnManage">Manage</button>
  </header>

  <!-- Match Entry Page -->
  <div id="matchEntryPage" class="page active">
    <form id="matchEntryForm">
      <h2>Match Entry</h2>
      <label for="matchDate">Match Date/Time:</label>
      <input type="datetime-local" id="matchDate">
      
      <label for="eventName">Event Name:</label>
      <input type="text" id="eventName" placeholder="e.g., Supreme Championship 11">
      
      <label for="clan1">Your Clan:</label>
      <select id="clan1"></select>
      <input type="text" id="clan1Text" placeholder="Or enter new clan">
      
      <label for="player1">Your Player Name:</label>
      <select id="player1"></select>
      <input type="text" id="player1Text" placeholder="Or enter new player">
      
      <label for="clan2">Opponent Clan:</label>
      <select id="clan2"></select>
      <input type="text" id="clan2Text" placeholder="Or enter new clan">
      
      <label for="player2">Opponent Player Name:</label>
      <select id="player2"></select>
      <input type="text" id="player2Text" placeholder="Or enter new player">
      
      <h3>Game Details (Best of 5)</h3>
      <div id="gameRows"></div>
      <button type="button" id="saveMatchButton">Save Match Set</button>
    </form>
    <div id="savedMatchesContainer">
      <h3>Saved Match Sets</h3>
      <div id="savedMatchesList"></div>
    </div>
  </div>

  <!-- Import Logs Page -->
  <div id="importLogsPage" class="page">
    <form id="logImportForm">
      <h2>Import Match Logs</h2>
      <label for="importEventName">Event Name:</label>
      <input type="text" id="importEventName" placeholder="e.g., Supreme Championship 11">
      
      <label for="importClan1">Your Clan:</label>
      <input type="text" id="importClan1" placeholder="e.g., Legends Rebirth">
      
      <label for="importClan2">Opponent Clan:</label>
      <input type="text" id="importClan2" placeholder="e.g., Arise">
      
      <label for="logTextarea">Paste Match Logs (one per line):</label>
      <textarea id="logTextarea" rows="10" placeholder="March 15, 2025 16:11    Peypey (Lee S Kakashi S Fukai) vs Tragicksz (Lee S Fuguki Dodai)    Winner Peypey"></textarea>
      <button type="button" id="importLogsButton">Import Logs</button>
    </form>
  </div>

  <!-- Statistics Page -->
  <div id="statsPage" class="page">
    <h2>Statistics</h2>
    <div id="statsControls">
      <button id="exportStatsButton">Export Stats Data</button>
      <input type="file" id="statsFile" accept=".json">
      <button id="importStatsButton">Import Stats Data</button>
      <button id="clearAllStatsButton">Clear All Stats</button>
      <label style="margin-left: 10px;">
        <input type="checkbox" id="sortByWinRateCheckbox"> Sort by Win Rate
      </label>
    </div>
    <div id="statsOutput"></div>
  </div>

  <!-- Manage Page -->
  <div id="managePage" class="page">
    <h2>Manage Clans and Players</h2>
    <div id="manageClans">
      <h3>Clans</h3>
      <form id="clanForm">
        <input type="text" id="newClanInput" placeholder="Enter new clan name">
        <button type="button" id="addClanButton">Add Clan</button>
      </form>
      <ul id="clanList" class="item-list"></ul>
    </div>
    <div id="managePlayers">
      <h3>Players</h3>
      <form id="playerForm">
        <input type="text" id="newPlayerInput" placeholder="Enter new player name">
        <select id="playerClanSelect"></select>
        <button type="button" id="addPlayerButton">Add Player</button>
      </form>
      <ul id="playerList" class="item-list"></ul>
    </div>
  </div>

  <!-- Character Picker Modal (for Match Entry team selection) -->
  <div id="characterPickerModal">
    <div class="modal-content">
      <h3>Select 3 Characters</h3>
      <input type="text" id="pickerFilter" placeholder="Search characters...">
      <div id="pickerGrid"></div>
      <div style="text-align: center; margin-top: 10px;">
        <button id="confirmPicker">Confirm</button>
        <button id="cancelPicker">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Import Characters JSON Section -->
  <div id="importCharactersSection" style="max-width:800px; margin: 20px auto; background:#fff; padding:15px; border:1px solid #ced4da; border-radius:6px;">
    <h3>Import Characters JSON</h3>
    <input type="file" id="jsonFile" accept=".json">
    <button id="loadJsonButton">Load Characters</button>
  </div>

  <script>
    /***** Global Variables *****/
    let characters = []; // Loaded from JSON file
    let savedMatchSets = JSON.parse(localStorage.getItem("savedMatchSets")) || [];
    let clans = JSON.parse(localStorage.getItem("clans")) || [];
    let players = JSON.parse(localStorage.getItem("players")) || [];
    
    // For the modal picker (Match Entry)
    let pickerContext = {}; // { gameIndex, side }
    let selectedPickerChars = [];

    // Utility: Save to localStorage
    function saveData() {
      localStorage.setItem("savedMatchSets", JSON.stringify(savedMatchSets));
      localStorage.setItem("clans", JSON.stringify(clans));
      localStorage.setItem("players", JSON.stringify(players));
    }
    
    /***** Navigation Between Pages *****/
    const pages = {
      matchEntry: document.getElementById('matchEntryPage'),
      importLogs: document.getElementById('importLogsPage'),
      stats: document.getElementById('statsPage'),
      manage: document.getElementById('managePage')
    };
    
    function showPage(pageId) {
      Object.values(pages).forEach(p => p.classList.remove('active'));
      pages[pageId].classList.add('active');
      // Update header buttons
      document.querySelectorAll("header button").forEach(btn => btn.classList.remove("active"));
      document.getElementById("btn" + pageId.charAt(0).toUpperCase() + pageId.slice(1)).classList.add("active");
      if (pageId === "matchEntry") renderSavedMatches();
      if (pageId === "stats") renderStats();
      if (pageId === "manage") { renderClanList(); renderPlayerList(); updatePlayerClanSelect(); }
    }
    document.getElementById('btnMatchEntry').addEventListener('click', () => showPage("matchEntry"));
    document.getElementById('btnImportLogs').addEventListener('click', () => showPage("importLogs"));
    document.getElementById('btnStats').addEventListener('click', () => showPage("stats"));
    document.getElementById('btnManage').addEventListener('click', () => showPage("manage"));
    
    /***** Match Entry Page Functions *****/
    // Initialize game rows (Best of 5)
    function initGameRows() {
      const container = document.getElementById("gameRows");
      container.innerHTML = "";
      for (let g = 0; g < 5; g++) {
        const rowDiv = document.createElement("div");
        rowDiv.className = "game-row";
        rowDiv.dataset.gameIndex = g;
        rowDiv.style.border = "1px solid #ccc";
        rowDiv.style.padding = "10px";
        rowDiv.style.marginBottom = "10px";
        rowDiv.innerHTML = `
          <h4>Game ${g+1}</h4>
          <div style="display:flex; gap:10px;">
            <div style="flex:1;">
              <strong>Your Team:</strong>
              <div class="team-picker-slot" data-game="${g}" data-side="team1" style="border: 2px dashed #aaa; padding:5px; text-align:center; cursor:pointer;">
                Double-click to select team
              </div>
            </div>
            <div style="flex:1;">
              <strong>Opponent Team:</strong>
              <div class="team-picker-slot" data-game="${g}" data-side="team2" style="border: 2px dashed #aaa; padding:5px; text-align:center; cursor:pointer;">
                Double-click to select team
              </div>
            </div>
          </div>
          <label>Winner:</label>
          <select class="winner-select" data-game="${g}">
            <option value="">--</option>
            <option value="team1">Your Team</option>
            <option value="team2">Opponent Team</option>
          </select>
        `;
        // Add double-click event for team selection
        rowDiv.querySelectorAll(".team-picker-slot").forEach(slot => {
          slot.addEventListener('dblclick', () => {
            openTeamPicker(parseInt(slot.dataset.game), slot.dataset.side);
          });
        });
        container.appendChild(rowDiv);
      }
    }
    initGameRows();
    
    // Open character picker modal
    function openTeamPicker(gameIndex, side) {
      pickerContext = { gameIndex, side };
      selectedPickerChars = [];
      document.getElementById("pickerFilter").value = "";
      renderPickerGrid("");
      document.getElementById("characterPickerModal").style.display = "flex";
    }
    
    // Render picker grid with filter text
    function renderPickerGrid(filterText) {
      const grid = document.getElementById("pickerGrid");
      grid.innerHTML = "";
      characters.forEach((char, index) => {
        if (char.name.toLowerCase().includes(filterText.toLowerCase())) {
          const div = document.createElement("div");
          div.className = "picker-item";
          div.dataset.index = index;
          div.innerHTML = `<img src="${char.url}" alt="${char.name}"><div style="font-size:10px;">${char.name}</div>`;
          if (selectedPickerChars.includes(index)) {
            div.classList.add("selected");
          }
          div.addEventListener("click", () => {
            if (selectedPickerChars.includes(index)) {
              selectedPickerChars = selectedPickerChars.filter(i => i !== index);
              div.classList.remove("selected");
            } else {
              if (selectedPickerChars.length < 3) {
                selectedPickerChars.push(index);
                div.classList.add("selected");
              } else {
                alert("You can only select 3 characters.");
              }
            }
          });
          grid.appendChild(div);
        }
      });
    }
    document.getElementById("pickerFilter").addEventListener("input", (e) => {
      renderPickerGrid(e.target.value);
    });
    
    document.getElementById("confirmPicker").addEventListener("click", () => {
      if (selectedPickerChars.length !== 3) {
        alert("Please select exactly 3 characters.");
        return;
      }
      const team = selectedPickerChars.map(i => characters[i]);
      const selector = `.team-picker-slot[data-game="${pickerContext.gameIndex}"][data-side="${pickerContext.side}"]`;
      const slot = document.querySelector(selector);
      if (slot) {
        slot.innerHTML = "";
        team.forEach(char => {
          slot.innerHTML += `<img src="${char.url}" alt="${char.name}" style="width:40px;height:40px; margin:2px;">`;
        });
        slot.dataset.teamData = JSON.stringify(team); // Store team info
      }
      document.getElementById("characterPickerModal").style.display = "none";
    });
    document.getElementById("cancelPicker").addEventListener("click", () => {
      document.getElementById("characterPickerModal").style.display = "none";
    });
    
    // Save Match Set from form
    document.getElementById("saveMatchButton").addEventListener("click", saveMatchSet);
    function saveMatchSet() {
      const matchDate = document.getElementById("matchDate").value;
      const eventName = document.getElementById("eventName").value.trim();
      
      // Get clan and player info from select or text field
      const clan1 = document.getElementById("clan1").value || document.getElementById("clan1Text").value.trim();
      const player1 = document.getElementById("player1").value || document.getElementById("player1Text").value.trim();
      const clan2 = document.getElementById("clan2").value || document.getElementById("clan2Text").value.trim();
      const player2 = document.getElementById("player2").value || document.getElementById("player2Text").value.trim();
      
      if (!matchDate || !eventName || !clan1 || !clan2 || !player1 || !player2) {
        alert("Please fill out all fields.");
        return;
      }
      
      const matchSet = {
        matchDate,
        event: eventName,
        clan1, player1,
        clan2, player2,
        games: []
      };
      
      // Loop through game rows and capture team selections and winner
      for (let g = 0; g < 5; g++) {
        const gameData = { team1: [], team2: [], winner: "" };
        const team1Slot = document.querySelector(`.team-picker-slot[data-game="${g}"][data-side="team1"]`);
        const team2Slot = document.querySelector(`.team-picker-slot[data-game="${g}"][data-side="team2"]`);
        if (team1Slot && team1Slot.dataset.teamData) {
          gameData.team1 = JSON.parse(team1Slot.dataset.teamData);
        }
        if (team2Slot && team2Slot.dataset.teamData) {
          gameData.team2 = JSON.parse(team2Slot.dataset.teamData);
        }
        const sel = document.querySelector(`select.winner-select[data-game="${g}"]`);
        if (sel) {
          gameData.winner = sel.value;
        }
        // Only add game if both teams have 3 characters
        if (gameData.team1.length === 3 && gameData.team2.length === 3) {
          matchSet.games.push(gameData);
        }
      }
      
      // Determine final set winner based on wins
      let team1Wins = 0, team2Wins = 0;
      matchSet.games.forEach(game => {
        if (game.winner === "team1") team1Wins++;
        if (game.winner === "team2") team2Wins++;
      });
      matchSet.finalSetWinner = team1Wins >= 3 ? "team1" : (team2Wins >= 3 ? "team2" : "");
      
      savedMatchSets.push(matchSet);
      saveData();
      alert("Match set saved!");
      document.getElementById("matchEntryForm").reset();
      initGameRows();
      renderSavedMatches();
    }
    
    // Render saved match sets
    function renderSavedMatches() {
      const container = document.getElementById("savedMatchesList");
      container.innerHTML = "";
      if (savedMatchSets.length === 0) {
        container.innerHTML = "<p>No match sets saved.</p>";
        return;
      }
      savedMatchSets.forEach((setObj, idx) => {
        const div = document.createElement("div");
        div.style.border = "1px solid #ccc";
        div.style.padding = "10px";
        div.style.marginBottom = "10px";
        let gamesHtml = "";
        setObj.games.forEach((game, gi) => {
          let team1Imgs = game.team1.map(c => `<img src="${c.url}" alt="${c.name}" style="width:30px;height:30px;margin-right:2px;">`).join("");
          let team2Imgs = game.team2.map(c => `<img src="${c.url}" alt="${c.name}" style="width:30px;height:30px;margin-right:2px;">`).join("");
          gamesHtml += `<p><strong>Game ${gi+1}:</strong> Your Team: ${team1Imgs} vs Opponent Team: ${team2Imgs} | Winner: ${game.winner}</p>`;
        });
        div.innerHTML = `
          <p><strong>Date:</strong> ${setObj.matchDate}</p>
          <p><strong>Event:</strong> ${setObj.event}</p>
          <p><strong>Clans:</strong> ${setObj.clan1} vs ${setObj.clan2}</p>
          <p><strong>Players:</strong> ${setObj.player1} vs ${setObj.player2}</p>
          <p><strong>Final Set Winner:</strong> ${setObj.finalSetWinner}</p>
          ${gamesHtml}
          <button onclick="deleteMatchSet(${idx})" style="padding:4px 8px;">Delete</button>
        `;
        container.appendChild(div);
      });
    }
    function deleteMatchSet(index) {
      if (confirm("Are you sure you want to delete this match set?")) {
        savedMatchSets.splice(index, 1);
        saveData();
        renderSavedMatches();
      }
    }
    
    /***** Import Logs Page Functions *****/
    // Simple Levenshtein distance function for fuzzy matching
    function levenshtein(a, b) {
      const matrix = [];
      for (let i = 0; i <= b.length; i++) {
        matrix[i] = [i];
      }
      for (let j = 0; j <= a.length; j++) {
        matrix[0][j] = j;
      }
      for (let i = 1; i <= b.length; i++) {
        for (let j = 1; j <= a.length; j++) {
          if (b.charAt(i - 1) === a.charAt(j - 1)) {
            matrix[i][j] = matrix[i - 1][j - 1];
          } else {
            matrix[i][j] = Math.min(
              matrix[i - 1][j - 1] + 1,
              matrix[i][j - 1] + 1,
              matrix[i - 1][j] + 1
            );
          }
        }
      }
      return matrix[b.length][a.length];
    }
    
    function fuzzyMatch(input, candidates) {
      input = input.toLowerCase();
      let bestMatch = null;
      let bestDistance = Infinity;
      candidates.forEach(candidate => {
        const distance = levenshtein(input, candidate.toLowerCase());
        if (distance < bestDistance) {
          bestDistance = distance;
          bestMatch = candidate;
        }
      });
      return (bestDistance <= Math.max(1, input.length * 0.4)) ? bestMatch : input;
    }
    
    // Parse a single log line
    function parseLogLine(line) {
      // Expected format:
      // "March 15, 2025 16:11    Peypey (Lee S Kakashi S Fukai) vs Tragicksz (Lee S Fuguki Dodai)    Winner Peypey"
      const regex = /^(.+?)\s+(.+?)\s*\((.+?)\)\s+vs\s+(.+?)\s*\((.+?)\)\s+Winner\s+(.+)$/i;
      const match = line.match(regex);
      if (!match) return null;
      const [_, dateStr, player1, team1Str, player2, team2Str, winner] = match;
      // Split teams into tokens
      let team1Tokens = team1Str.split(" ").filter(t => t.trim() !== "");
      let team2Tokens = team2Str.split(" ").filter(t => t.trim() !== "");
      const characterNames = characters.map(c => c.name);
      team1Tokens = team1Tokens.map(token => fuzzyMatch(token, characterNames));
      team2Tokens = team2Tokens.map(token => fuzzyMatch(token, characterNames));
      const team1 = team1Tokens.map(token => characters.find(c => c.name === token) || { name: token, url: "" });
      const team2 = team2Tokens.map(token => characters.find(c => c.name === token) || { name: token, url: "" });
      let winnerSide = "";
      if (winner.trim().toLowerCase() === player1.trim().toLowerCase()) {
        winnerSide = "team1";
      } else if (winner.trim().toLowerCase() === player2.trim().toLowerCase()) {
        winnerSide = "team2";
      }
      return {
        date: new Date(dateStr).toISOString(),
        player1: player1.trim(),
        team1,
        player2: player2.trim(),
        team2,
        winner: winnerSide
      };
    }
    
    document.getElementById("importLogsButton").addEventListener("click", importLogs);
    function importLogs() {
      const eventName = document.getElementById("importEventName").value.trim();
      const clan1 = document.getElementById("importClan1").value.trim();
      const clan2 = document.getElementById("importClan2").value.trim();
      const logText = document.getElementById("logTextarea").value;
      if (!eventName || !clan1 || !clan2 || !logText) {
        alert("Please fill out all fields and paste log text.");
        return;
      }
      const lines = logText.split("\n").filter(line => line.trim() !== "");
      const parsedGames = [];
      lines.forEach(line => {
        const game = parseLogLine(line);
        if (game) parsedGames.push(game);
      });
      if (parsedGames.length === 0) {
        alert("No valid log lines parsed.");
        return;
      }
      // Group games by player1, player2, and date (using the date portion)
      const groups = {};
      parsedGames.forEach(game => {
        const dateKey = game.date.split("T")[0];
        const key = game.player1 + "|" + game.player2 + "|" + dateKey;
        if (!groups[key]) groups[key] = [];
        groups[key].push(game);
      });
      for (let key in groups) {
        const games = groups[key];
        const firstGame = games[0];
        const matchSet = {
          matchDate: firstGame.date,
          event: eventName,
          clan1,
          player1: firstGame.player1,
          clan2,
          player2: firstGame.player2,
          games: games.map(g => ({
            team1: g.team1,
            team2: g.team2,
            winner: g.winner
          }))
        };
        let team1Wins = 0, team2Wins = 0;
        matchSet.games.forEach(game => {
          if (game.winner === "team1") team1Wins++;
          if (game.winner === "team2") team2Wins++;
        });
        matchSet.finalSetWinner = team1Wins >= 3 ? "team1" : (team2Wins >= 3 ? "team2" : "");
        savedMatchSets.push(matchSet);
      }
      saveData();
      alert("Logs imported successfully!");
      document.getElementById("logImportForm").reset();
    }
    
    /***** Statistics Functions *****/
    const statsOutput = document.getElementById('statsOutput');
    document.getElementById('exportStatsButton').addEventListener('click', exportStatsData);
    document.getElementById('importStatsButton').addEventListener('click', importStatsData);
    document.getElementById('clearAllStatsButton').addEventListener('click', clearAllStats);
    document.getElementById('sortByWinRateCheckbox').addEventListener('change', renderStats);
    function exportStatsData() {
      const dataStr = JSON.stringify(savedMatchSets, null, 2);
      const blob = new Blob([dataStr], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "war_manager_stats.json";
      a.click();
      URL.revokeObjectURL(url);
    }
    function importStatsData() {
      const fileInput = document.getElementById('statsFile');
      const file = fileInput.files[0];
      if (!file) {
        alert("Please choose a JSON file for stats first.");
        return;
      }
      const reader = new FileReader();
      reader.onload = function(event) {
        try {
          const imported = JSON.parse(event.target.result);
          if (!Array.isArray(imported)) {
            alert("Invalid stats data format. Expected an array.");
            return;
          }
          savedMatchSets = imported;
          saveData();
          alert("Stats data imported.");
          renderStats();
        } catch (err) {
          console.error("Error parsing Stats JSON file:", err);
          alert("Error parsing Stats JSON file: " + err);
        }
      };
      reader.readAsText(file);
    }
    function clearAllStats() {
      if (!confirm("Are you sure you want to clear all stats? This cannot be undone.")) return;
      savedMatchSets = [];
      localStorage.removeItem("savedMatchSets");
      alert("All stats cleared.");
      renderStats();
    }
    function renderStats() {
      statsOutput.innerHTML = "";
      if (!Array.isArray(savedMatchSets) || savedMatchSets.length === 0) {
        statsOutput.innerHTML = "<p>No match data to show. Import or create some match sets first.</p>";
        return;
      }
      const sortByWinRate = document.getElementById('sortByWinRateCheckbox').checked;
      const playerStats = {};
      const clanStats = {};
      const charStats = {};
      const teamStats = {};
      
      savedMatchSets.forEach(setObj => {
        // Player Stats
        if (setObj.player1) {
          if (!playerStats[setObj.player1]) playerStats[setObj.player1] = { setsPlayed: 0, setsWon: 0 };
          playerStats[setObj.player1].setsPlayed++;
        }
        if (setObj.player2) {
          if (!playerStats[setObj.player2]) playerStats[setObj.player2] = { setsPlayed: 0, setsWon: 0 };
          playerStats[setObj.player2].setsPlayed++;
        }
        if (setObj.finalSetWinner === "team1" && setObj.player1) {
          playerStats[setObj.player1].setsWon++;
        }
        if (setObj.finalSetWinner === "team2" && setObj.player2) {
          playerStats[setObj.player2].setsWon++;
        }
        // Clan Stats
        if (setObj.clan1) {
          if (!clanStats[setObj.clan1]) clanStats[setObj.clan1] = { setsPlayed: 0, setsWon: 0 };
          clanStats[setObj.clan1].setsPlayed++;
        }
        if (setObj.clan2) {
          if (!clanStats[setObj.clan2]) clanStats[setObj.clan2] = { setsPlayed: 0, setsWon: 0 };
          clanStats[setObj.clan2].setsPlayed++;
        }
        if (setObj.finalSetWinner === "team1" && setObj.clan1) {
          clanStats[setObj.clan1].setsWon++;
        }
        if (setObj.finalSetWinner === "team2" && setObj.clan2) {
          clanStats[setObj.clan2].setsWon++;
        }
        // Character and Team Stats from games
        setObj.games.forEach(game => {
          game.team1.forEach(c => {
            if (c && c.name) {
              if (!charStats[c.name]) charStats[c.name] = { used: 0, wins: 0 };
              charStats[c.name].used++;
            }
          });
          game.team2.forEach(c => {
            if (c && c.name) {
              if (!charStats[c.name]) charStats[c.name] = { used: 0, wins: 0 };
              charStats[c.name].used++;
            }
          });
          const winningTeam = game.winner === "team1" ? game.team1 : (game.winner === "team2" ? game.team2 : []);
          winningTeam.forEach(c => {
            if (c && c.name) {
              if (!charStats[c.name]) charStats[c.name] = { used: 0, wins: 0 };
              charStats[c.name].wins++;
            }
          });
          if (game.team1.length === 3) {
            const key = game.team1.map(c => c.name).sort().join(" | ");
            if (!teamStats[key]) teamStats[key] = { played: 0, wins: 0 };
            teamStats[key].played++;
            if (game.winner === "team1") teamStats[key].wins++;
          }
          if (game.team2.length === 3) {
            const key = game.team2.map(c => c.name).sort().join(" | ");
            if (!teamStats[key]) teamStats[key] = { played: 0, wins: 0 };
            teamStats[key].played++;
            if (game.winner === "team2") teamStats[key].wins++;
          }
        });
      });
      
      let html = "";
      // Player Stats Table
      html += "<h3>Player Set Win Rates</h3>";
      html += "<table><tr><th>Player</th><th>Sets Played</th><th>Sets Won</th><th>Win Rate</th></tr>";
      let playersArr = Object.keys(playerStats).map(p => {
        const ps = playerStats[p];
        const winRate = ps.setsPlayed > 0 ? (ps.setsWon/ps.setsPlayed) : 0;
        return {name: p, setsPlayed: ps.setsPlayed, setsWon: ps.setsWon, winRate};
      });
      if (sortByWinRate) playersArr.sort((a,b)=> b.winRate - a.winRate);
      playersArr.forEach(p => {
        html += `<tr><td>${p.name}</td><td>${p.setsPlayed}</td><td>${p.setsWon}</td><td>${(p.winRate*100).toFixed(1)}%</td></tr>`;
      });
      html += "</table>";
      
      // Clan Stats Table
      html += "<h3>Clan Set Win Rates</h3>";
      html += "<table><tr><th>Clan</th><th>Sets Played</th><th>Sets Won</th><th>Win Rate</th></tr>";
      let clansArr = Object.keys(clanStats).map(c => {
        const cs = clanStats[c];
        const winRate = cs.setsPlayed > 0 ? (cs.setsWon/cs.setsPlayed) : 0;
        return {clan: c, setsPlayed: cs.setsPlayed, setsWon: cs.setsWon, winRate};
      });
      if (sortByWinRate) clansArr.sort((a,b)=> b.winRate - a.winRate);
      clansArr.forEach(c => {
        html += `<tr><td>${c.clan}</td><td>${c.setsPlayed}</td><td>${c.setsWon}</td><td>${(c.winRate*100).toFixed(1)}%</td></tr>`;
      });
      html += "</table>";
      
      // Character Stats Table
      html += "<h3>Character Usage and Win Rates</h3>";
      html += "<table><tr><th>Character</th><th>Used</th><th>Wins</th><th>Win Rate</th></tr>";
      let charsArr = Object.keys(charStats).map(ch => {
        const cs = charStats[ch];
        const winRate = cs.used > 0 ? (cs.wins/cs.used) : 0;
        return {character: ch, used: cs.used, wins: cs.wins, winRate};
      });
      if (sortByWinRate) charsArr.sort((a,b)=> b.winRate - a.winRate);
      charsArr.forEach(ch => {
        html += `<tr><td>${ch.character}</td><td>${ch.used}</td><td>${ch.wins}</td><td>${(ch.winRate*100).toFixed(1)}%</td></tr>`;
      });
      html += "</table>";
      
      // Team Stats Table
      html += "<h3>Team Win Rates</h3>";
      html += "<table><tr><th>Team (3 characters)</th><th>Played</th><th>Wins</th><th>Win Rate</th></tr>";
      let teamsArr = Object.keys(teamStats).map(key => {
        const ts = teamStats[key];
        const winRate = ts.played > 0 ? (ts.wins/ts.played) : 0;
        return {team: key, played: ts.played, wins: ts.wins, winRate};
      });
      if (sortByWinRate) teamsArr.sort((a,b)=> b.winRate - a.winRate);
      teamsArr.forEach(t => {
        html += `<tr><td>${t.team}</td><td>${t.played}</td><td>${t.wins}</td><td>${(t.winRate*100).toFixed(1)}%</td></tr>`;
      });
      html += "</table>";
      
      statsOutput.innerHTML = html;
    }
    
    /***** Manage Page Functions *****/
    function renderClanList() {
      const list = document.getElementById("clanList");
      list.innerHTML = "";
      clans.forEach((clan, idx) => {
        const li = document.createElement("li");
        li.textContent = clan;
        li.onclick = () => {
          if (confirm("Delete clan: " + clan + "?")) {
            clans.splice(idx, 1);
            saveData();
            renderClanList();
            updateClanSelects();
          }
        };
        list.appendChild(li);
      });
      updateClanSelects();
    }
    function updateClanSelects() {
      const clan1Select = document.getElementById("clan1");
      const clan2Select = document.getElementById("clan2");
      [clan1Select, clan2Select].forEach(select => {
        select.innerHTML = "<option value=''>--Select--</option>";
        clans.forEach(clan => {
          const opt = document.createElement("option");
          opt.value = clan;
          opt.textContent = clan;
          select.appendChild(opt);
        });
      });
    }
    document.getElementById("addClanButton").addEventListener("click", () => {
      const input = document.getElementById("newClanInput");
      const clanName = input.value.trim();
      if (clanName && !clans.includes(clanName)) {
        clans.push(clanName);
        saveData();
        input.value = "";
        renderClanList();
      }
    });
    
    function renderPlayerList() {
      const list = document.getElementById("playerList");
      list.innerHTML = "";
      players.forEach((player, idx) => {
        const li = document.createElement("li");
        li.textContent = player.name + " (" + player.clan + ")";
        li.onclick = () => {
          if (confirm("Delete player: " + player.name + "?")) {
            players.splice(idx, 1);
            saveData();
            renderPlayerList();
            updatePlayerSelects();
          }
        };
        list.appendChild(li);
      });
      updatePlayerSelects();
    }
    function updatePlayerSelects() {
      const player1Select = document.getElementById("player1");
      const player2Select = document.getElementById("player2");
      [player1Select, player2Select].forEach(select => {
        select.innerHTML = "<option value=''>--Select--</option>";
        players.forEach(player => {
          const opt = document.createElement("option");
          opt.value = player.name;
          opt.textContent = player.name;
          select.appendChild(opt);
        });
      });
    }
    function updatePlayerClanSelect() {
      const select = document.getElementById("playerClanSelect");
      select.innerHTML = "<option value=''>--Select Clan--</option>";
      clans.forEach(clan => {
        const opt = document.createElement("option");
        opt.value = clan;
        opt.textContent = clan;
        select.appendChild(opt);
      });
    }
    document.getElementById("addPlayerButton").addEventListener("click", () => {
      const playerName = document.getElementById("newPlayerInput").value.trim();
      const clan = document.getElementById("playerClanSelect").value;
      if (playerName && clan) {
        if (!players.find(p => p.name.toLowerCase() === playerName.toLowerCase())) {
          players.push({ name: playerName, clan });
          saveData();
          document.getElementById("newPlayerInput").value = "";
          renderPlayerList();
        } else {
          alert("Player already exists.");
        }
      } else {
        alert("Please enter player name and select a clan.");
      }
    });
    
    /***** Import Characters JSON *****/
    document.getElementById('loadJsonButton').addEventListener('click', () => {
      const fileInput = document.getElementById('jsonFile');
      const file = fileInput.files[0];
      if (!file) {
        alert("Please choose a JSON file first.");
        return;
      }
      const reader = new FileReader();
      reader.onload = function(event) {
        try {
          const jsonData = JSON.parse(event.target.result);
          characters = Array.isArray(jsonData) ? jsonData : (jsonData.characters && Array.isArray(jsonData.characters) ? jsonData.characters : []);
          if (characters.length === 0) {
            alert("No character data found. Please check your JSON file format.");
          } else {
            alert("Characters loaded successfully.");
          }
        } catch (err) {
          console.error("Error parsing JSON file:", err);
          alert("Failed to parse JSON file. Please check its format.");
        }
      };
      reader.readAsText(file);
    });
    
    // Initial population of dropdowns
    updateClanSelects();
    updatePlayerSelects();
    updatePlayerClanSelect();
  </script>
</body>
</html>
